---
title: "cytoRSuite: Visualisation of Flow Cytometry Data Using plotCyto"
author: "Dillon Hammill"
date: "4 November 2018"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cytoRSuite: Visualisation of Flow Cytometry Data Using plotCyto}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introduction

**cytoRSuite** contains a lightweight plotting function built on base graphics called **plotCyto** which supports all existing flow cytometry objects including flowFrames, flowSets, GatingHierarchies and GatingSets. Some key plotting features include:

- sensible defaults to minimise code
- back gating support with **overlay**
- plot **gate** objects
- label gated populations with name and frequency
- sample merging
- **subSample** to sample events to speed up plotting
- stack density histograms with **offset**
- 2D scatter plots with default blue-red colour scale
- 2D **contour lines** overlays

**plotCyto** is used internally throughout cytoRSuite so any plotCyto arguments can be passed to functions which generate plots, including drawGate and editGate.

## 2. plotCyto Demonstration

Here we aim to document some of the key features of plotCyto for visualation of flow cytometry data. To accomplish this goal we will use the Activation dataset supplied with **cytoRSuite**.

### 2.1 Preparation of Flow Cytometry Data
```{r, message = FALSE, warning = FALSE}
# Load Required Packages
library(cytoRSuite)

# Prepare Data
fs <- Activation

# Add Marker Names
chnls <- c("Alexa Fluor 405-A","Alexa Fluor 430-A","APC-Cy7-A", "PE-A", "Alexa Fluor 488-A", "Alexa Fluor 700-A", "Alexa Fluor 647-A", "7-AAD-A") 
markers <- c("Hoechst-405", "Hoechst-430", "CD11c", "Va2", "CD8", "CD4", "CD44", "CD69")
names(markers) <- chnls
markernames(fs) <- markers

# Add fs to GatingSet
gs <- GatingSet(fs)

# Apply Compensation
gs <- compensate(gs, fs[[1]]@description$SPILL)

# Transform Fluorescent Channels
channels <- getChannels(gs)
trans <- estimateLogicle(gs[[1]], channels)
gs <- transform(gs, trans)

# Apply Saved Gates
gt <- system.file("extdata", "Example-gatingTemplate.csv", package = "cytoRSuite")
gt <- gatingTemplate(gt)
gating(gt,gs)

# Pull out T Cells Population 
TCells <- getData(gs, "T Cells")

```


### 2.2 plotCyto Overview

At its most basic level, plotCyto constructs either a 1-D or 2-D plot based on the number of channels supplied to the channels argument. To construct the plot in a pop-up window simply set the popup argument to TRUE. Note: for larger plots users will need to expand the plotting area to avoid figure margins errors.

If a single channel is supplied a 1-D density distribution is plotted. All density distributions are normalised to the mode by default by this can be changed by setting **modal** to FALSE.

```{r, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(fs[[1]], channels = "FSC-A")
```

If two channels are supplied a 2-D scatterplot with blue-red colour gradient is contructed.

```{r, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(fs[[1]], channels = c("FSC-A","SSC-A"))
```

### 2.3 plotCyto: 1-Dimensional Density Distibutions

To get 1-D density distributions of the data, simply supply a single channel or marker name to the channels argument. 

#### flowFrame

```{r, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(TCells[[1]], channels = "CD4")
```

#### flowSet

The density distribution for each flowFrame within the flowSet will be plotted in a separate panel by default. Notice how the x axis in the above plot has limits [0,4] this is due to flowFrame and flowSet objects not retaining the logicle transformation information. To have appropriately labelled axes users should supply a transformList object to the transList argument as shown below. The **fill** argument controls the fill colour for the density distribution.

```{r, fig.width = 11, fig.height = 5, fig.align='center'}
trans <- estimateLogicle(fs[[2]], channels)
plotCyto(TCells, channels = "CD4", fill = "dodgerblue", transList = trans)
```

Stacking of samples is supported through the **stack** argument which controls the percentage overlap of the stacked distributions. The **alpha** argument controls the degree of transparency of the fill colour.

```{r, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(TCells, channels = "CD4", fill = c("dodgerblue", "red"), stack = 0.5, alpha = 0.5)
```

#### GatingHierarchy

To plot objects of class GatingHierachy supply the name of the **parent** population to extract for plotting. Population overlays are supported for flowFrame, flowSet, list of flowFrames or list of flowSets using the **overlay** argument. For GatingHierachies and GatingSets the name of the population to overlay is also supported. The degree of overlap for overlays can be controlled using the **offset** argument. For 1-D density distribution the **col** argument controls the border colour.

```{r, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(gs[[1]], parent = "T Cells", channels = "CD4", overlay = "CD4 T Cells", fill = c("green","blue"), col = c("black","red"))
``` 

#### GatingSet

To change the border line type user can supply an interger [0,4] to the **lty** argument. The line width can be controlled in a similar fashion using the **lwd** argument. By default the title above each plot will be the name of the sample but this can be changed by supplying specific names to the **main** argument.

```{r, fig.width = 11, fig.height = 5, fig.align='center'}
plotCyto(gs, parent = "T Cells", channels = "CD4", lty = 2, lwd = 4, main = c("Unactivated","Activated"))
```

### 2.4 plotCyto: 2-Dimensional Scatter Plots

To get 2-D density scatter plots of the data, simply supply two channels or marker names to the **channels** argument of plotCyto. 

#### flowFrame

By default 2-D scatter plots will use a blue-red colour scale for points, this can be modified using the  **col** argument. To modify axes labels simply supply the desired labels to the **xlab** and **ylab** arguments. The axes limits can be modified by suppling the lower and upper limits to the **xlim** and **ylim** arguments.

```{r, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(TCells[[1]], channels = c("CD4","CD8"), transList = trans, xlab = "CD4", ylab = "CD8", xlim = c(-0.5,3.5), ylim = c(-0.5,4))
```

#### flowSet

Contour lines are also supported for 2-D scatter plots, simply supply the number of contours levels to the **contours** argument. User can use the **col.contour** and **lwd.contour** to modify the colour and line width of the contour lines respectively.

```{r, fig.width = 11, fig.height = 5, fig.align='center'}
plotCyto(TCells, channels = c("CD4","CD8"), transList = trans, contours = 15)
```

#### GatingHierarchy

**plotCyto** also has full support for plotting gates, simply supply the gate object to the **gates** argument or for GatingHierarchies and GatingSet simply supply the name of the gated population to the **alias** argument. Users can use the the **col.gate**, **lty.gate** and **lwd.gate** arguments to modify the gate colour, line type or line width.

```{r, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(gs[[1]], parent = "T Cells", alias = c("CD4 T Cells","CD8 T Cells"), channels = c("CD4","CD8"))
```

#### GatingSet

Overlays are also supported in 2-D scatterplots, simply supply the name of the gated population to the **overlay**. Overlay also accepts the following objects: flowFrames, flowSets, list of flowFrames or list of flowSets which allow overlay of any data. The colour of the overlay is also controlled by the col argument, simply supply a colour for the base plot and a colour for each overlay. Here we will set the colour of the base plot to "grey" and the overlay colours to "purple" and "blue". To include a legend in the plot users can set the **legend** argument to TRUE. To show the layering used within plotCyto we have added some contours as well.

```{r, fig.width = 12, fig.height = 5, fig.align='center'}
plotCyto(gs, parent = "T Cells", alias = c("CD4 T Cells","CD8 T Cells"), channels = c("CD4","CD8"), contours = 15, overlay = c("CD4 T Cells","CD8 T Cells"), col = c("grey","purple", "blue"), alpha = 0.5, legend = TRUE)
```

### Export High Resolution Images

```{r, eval = FALSE}
png("Activation.png", res = 600, height = 5, width = 13, units = "in")

plotCyto(gs, parent = "T Cells", alias = c("CD4 T Cells","CD8 T Cells"), channels = c("CD4","CD8"), contours = 15, overlay = c("CD4 T Cells","CD8 T Cells"), col = c("grey","purple", "blue"), alpha = 0.5, legend = TRUE)

dev.off()
```

## 3. More information

For more information refer to the cytoRSuite vignettes and help documentation for each of the described functions.

Dillon Hammill, BMedSci (Hons)
<br /> Ph.D. Scholar
<br /> The Parish Group Cancer & Vascular Biology
<br /> ACRF Department of Cancer Biology and Therapeutics
<br /> The John Curtin School of Medical Research
<br /> ANU College of Medicine, Biology and the Environment
<br /> The Australian National University
<br /> Acton ACT 2601
<br /> Dillon.Hammill@anu.edu.au