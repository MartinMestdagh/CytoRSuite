---
title: "cytoRSuite: Gate Manipulation Using editGate & removeGate"
author: "Dillon Hammill"
date: "4 November 2018"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cytoRSuite: Gate Manipulation Using editGate & removeGate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **1. Introduction**

Manipulation of gates saved to the gatingTemplate is possible through the **removeGate** and **editGate** functions. As their names suggest **removeGate** will remove the gate from the GatingSet and the gatingTemplate, whilst **editGate** allows the user to update an existing gate and update the GatingSet and gatingTemplate. This vignette aims to demonstrate the appropriate use of these functions for manipulating gates using **cytoRSuite**.

## **2. Gate Manipulation in cytoRSuite**

To demonstrate **editGate** and **removeGate** we will use the "Activation" flowSet shipped with cytoRSuite. For more details refer to **?Activation**.

## 2.1. Prepare Samples for Gating
```{r, eval = TRUE, message = FALSE, warning = FALSE}
library(cytoRSuite, quietly = TRUE)

# Load in Activation dataset
fs <- Activation

# Add Samples to GatingSet
gs <- GatingSet(fs)

# Extract spillover matrix from flowFrame description slot - see ?computeSpillover ?editSpillover
spill <- fs[[1]]@description$SPILL

# Apply compensation to samples & save to object fs
gs <- compensate(gs, spill)

# Apply logicle transformation to all fluorescent channels
trans <- estimateLogicle(gs[[1]], colnames(spill))
gs <- transform(gs, trans)
```

```{r, eval = TRUE, echo = FALSE, message = FALSE}
gt <- suppressMessages(gatingTemplate("Gate-Manipulation/Manipulation-gatingTemplate-Full.csv"))
suppressMessages(gating(gt,gs))
```

## 2.2. Gate Samples Using drawGate
```{r, eval = FALSE, message = FALSE}
drawGate(gs,
         parent = "root",
         alias = "Cells",
         channels = c("FSC-A","SSC-A"),
         type = "p",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r, echo = FALSE, eval = TRUE, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(gs, parent = "root", alias = "Cells", channels = c("FSC-A","SSC-A"), merge = TRUE)
```

```{r, eval = FALSE, message = FALSE}
drawGate(gs,
         parent = "Cells",
         alias = "Single Cells",
         channels = c("FSC-A","FSC-H"),
         type = "p",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r, echo = FALSE, eval = TRUE, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(gs, parent = "Cells", alias = "Single Cells", channels = c("FSC-A","FSC-H"), merge = TRUE)
```

```{r, eval = FALSE, message = FALSE}
drawGate(gs,
         parent = "Single Cells",
         alias = "Live Cells",
         channels = c("Alexa Fluor 405-A","Alexa Fluor 430-A"),
         type = "boundary",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r, echo = FALSE, eval = TRUE, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(gs, parent = "Single Cells", alias = "Live Cells", channels = c("Alexa Fluor 405-A","Alexa Fluor 430-A"), merge = TRUE)
```

```{r, eval = FALSE, message = FALSE}
drawGate(gs,
         parent = "Live Cells",
         alias = "T Cells",
         channels = "PE-A",
         type = "interval",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r, echo = FALSE, eval = TRUE, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(gs, parent = "Live Cells", alias = "T Cells", channels = "PE-A", merge = TRUE)
```

```{r, eval = FALSE, message = FALSE}
drawGate(gs,
         parent = "T Cells",
         alias = c("CD4 T Cells","CD8 T Cells"),
         channels = c("Alexa Fluor 700-A","Alexa Fluor 488-A"),
         type = "rectangle",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r, echo = FALSE, eval = TRUE, fig.width = 5.5, fig.width = 6, fig.height = 6, fig.align='center'}
plotCyto(gs, parent = "T Cells", alias = c("CD4 T Cells","CD8 T Cells"), channels = c("Alexa Fluor 700-A","Alexa Fluor 488-A"), merge = TRUE)
```

## **3. editGate**

**editGate** provides a simple way to modify existing gates applied to the GatingSet and saved to the gatingTemplate csv file. **editGate** features:

* Re-plots the data with the existing gate(s) in pink.
* Determines which **drawGate** type was used to construct the gate(s).
* Makes the appropriate call to **cytoRSuite** gating function(s) to allow the user to re-draw the gate(s) in red.
* Applies the new gate(s) to the GatingSet.
* Updates the relevant entries in the gatingTemplate.

The **type** argument is not necessary if the type of the new gate is to be the same as the old one. This argument allows users to change the **type** of the existing gate(s) if necessary. We will demonstrate its use below:

Since no type is supplied the new gate will have the same type as the existing gate:
```{r, eval = FALSE, message = FALSE}
editGate(gs,
         parent = "root",
         alias = "Cells",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r echo=FALSE, out.width='85%', out.height='85%',fig.align="center"}
knitr::include_graphics('Gate-Manipulation/editGate1.png')
```

Let's update the Single Cells gate as well:
```{r, eval = FALSE, message = FALSE}
editGate(gs,
         parent = "Cells",
         alias = "Single Cells",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r echo=FALSE, out.width='85%', out.height='85%',fig.align="center"}
knitr::include_graphics('Gate-Manipulation/editGate2.png')
```

Changing the type argument will alter the gate type of the existing gate. for example type = "ellipse" will change the existing rectangle gate to an ellipsoid gate:
```{r, eval = FALSE, message = FALSE}
editGate(gs,
         parent = "T Cells",
         alias = "CD4 T Cells",
         type = "ellipse",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r echo=FALSE, out.width='85%', out.height='85%',fig.align="center"}
knitr::include_graphics('Gate-Manipulation/editGate3.png')
```

Users can edit any gates with **editGate** including 1-D interval gates:
```{r, eval = FALSE, message = FALSE}
editGate(gs,
         parent = "Live Cells",
         alias = "T Cells",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r echo=FALSE, out.width='85%', out.height='85%',fig.align="center"}
knitr::include_graphics('Gate-Manipulation/editGate4.png')
```

Users can also pass plotCyto arguments to editGate. For example we can add some 2-D contours lines to help determine where the gate should be drawn:
```{r, eval = FALSE, message = FALSE}
editGate(gs,
         parent = "T Cells",
         alias = "CD8 T Cells",
         gtfile = "Manipulation gatingTemplate.csv", 
         contours = 15)
```

```{r echo=FALSE, out.width='85%', out.height='85%',fig.align="center"}
knitr::include_graphics('Gate-Manipulation/editGate5.png')
```

Back-gating is also fully supported in editGate through plotCyto's overlay argument. For example if we would like to see where the T Cells population falls on FSC-A and SSC-A:
```{r, eval = FALSE, message = FALSE}
editGate(gs,
         parent = "root",
         alias = "Cells",
         overlay = "T Cells",
         gtfile = "Manipulation gatingTemplate.csv")
```

```{r echo=FALSE, out.width='85%', out.height='85%',fig.align="center"}
knitr::include_graphics('Gate-manipulation/editGate6.png')
```

Visualise the new gating strategy using plotCytoGates (result not shown).
```{r, eval = FALSE}
plotCytoGates(gs[[2]])
```

## **4. removeGate**

**removeGate** simply removes the selected gate(s) and associated descendant populations from the GatingSet and the gatingTemplate. Removal of multiple populations in a single call is supported as long as these populations share the same parent. **removeGate** features:

* Remove gate(s) from GatingSet.
* Remove gate(s) entries from the gatingTemplate.

For example to remove the T Cells gate:
```{r, eval = FALSE, message = FALSE}
removeGate(gs,
           alias = "T Cells",
           gtfile = "Manipulation gatingTemplate.csv")
```

```{r, eval = TRUE, echo = FALSE, message = FALSE}
gt <- suppressMessages(gatingTemplate("Gate-Manipulation/Manipulation-gatingTemplate.csv"))
gs <- getData(gs, "root")
gs <- GatingSet(gs)
suppressMessages(gating(gt,gs))
```

T Cells node no longer exists in the GatingSet:
```{r, eval = TRUE}
getNodes(gs)
```

T Cells node no longer exists in the gatingTemplate:
```{r, eval = FALSE}
gatingTemplate("Manipulation gatingTemplate.csv")
```

```{r, eval = TRUE, echo = FALSE}
gatingTemplate("Gate-Manipulation/Manipulation-gatingTemplate.csv")
```

## 5. More information

For more information refer to the cytoRSuite vignettes and help documentation for each of the described functions.

Dillon Hammill, BMedSci (Hons)
<br /> Ph.D. Scholar
<br /> The Parish Group & Cancer & Vascular Biology
<br /> ACRF Department of Cancer Biology and Therapeutics
<br /> The John Curtin School of Medical Research
<br /> ANU College of Medicine, Biology and the Environment
<br /> The Australian National University
<br /> Acton ACT 2601
<br /> Dillon.Hammill@anu.edu.au